#!/usr/bin/env bash

# Virgo VIM plugin manager
# Copyright (C) 2016, Leonardo Cecchi
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# This is a simple script to manage vim packages
# and it's an alternative to other complex plugin
# managers

# Print an error message and then exit
function error() {
	>&2 echo "$1" 
}


# Create the needed directories to install the
# plugins
function create_required_dirs() {
	mkdir -p ~/.vim/plugins
	mkdir -p ~/.vim/autoload
}

# Install a plugin
function plugin_install() {
	if [ -z "$1" ]; then
		error "Usage: $0 install [git-repo-url]"
		exit 1
	fi

	plug_name="$1"
	if [[ ! "$plug_name" == "http://*" ]]; then
		plug_name="http://github.com/$plug_name"
		echo "Assuming git repo at $plug_name"
	fi	

	cd ~/.vim/plugins || exit 1
	git clone "$plug_name"

	generate_autoload

	# Generate helptags
	vim -c "helpt ALL" -c "quit"
}

# List installed plugins
function plugin_list() {
	cd ~/.vim/plugins || exit 1
	for plugin_name in *; do
		echo "$plugin_name"
	done
}

# Remove plugins
function plugin_remove() {
	if [ -z "$1" ]; then
		error "Usage: $0 remove [plugin-name]"
		exit 1
	fi

	cd ~/.vim/plugins || exit 1

	if [ ! -d "$1" ]; then
		error "Plugin $1 not installed"
		exit 1
	fi

	rm -rf "$1"
}

# Update plugins
function plugin_update() {
	cd ~/.vim/plugins || exit 1
	for plug_name in *; do
		echo "Updating $plug_name"
		cd "$HOME/.vim/plugins/$plug_name" || exit 1
		git pull --rebase origin
	done
}

# Generate vim autoload function
function generate_autoload() {
	echo "\" Generated by virgo" > ~/.vim/autoload/virgo.vim
	echo "function! virgo#load()" >> ~/.vim/autoload/virgo.vim
	cd ~/.vim/plugins || exit 1
	for dirname in *; do
		echo "set rtp+=$(realpath "$dirname")" >> ~/.vim/autoload/virgo.vim
	done
	echo "endfunction" >> ~/.vim/autoload/virgo.vim
}

# Print usage information
function usage() {
	error "Usage: $0 [command] [arguments]"
	error
	error "install [git-repo-url]"
	error "list"
	error "remove [plugin-name]"
	error "update"
	error
	error "Virgo, Copyright (C) 2016 Leonardo Cecchi"
	error "This program comes with ABSOLUTELY NO WARRANTY; for details type \`show w'."
	error "This is free software, and you are welcome to redistribute it"
	error "under certain conditions; type \`show c' for details."
	error

	exit 1
}

create_required_dirs
if [ "$1" == "install" ]; then
	plugin_install "$2"
elif [ "$1" == "list" ]; then
	plugin_list "$2"
elif [ "$1" == "remove" ]; then
	plugin_remove "$2"
elif [ "$1" == "update" ]; then
	plugin_update "$2"
else
	usage
fi
